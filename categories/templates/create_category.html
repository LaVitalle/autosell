{% extends 'dashboard.html' %}

{% block content %}
<!-- Layout Zero Scroll - Altura Fixa 100vh -->
<div class="max-w-7xl mx-auto h-full flex flex-col mobile-content-padding">
  
  <!-- Header Compacto -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
    <!-- Título com Ícone -->
    <div class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-neutral-100 dark:bg-neutral-700 rounded-lg flex items-center justify-center">
        <svg class="w-4 h-4 text-neutral-600 dark:text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
      </div>
      <div>
        <h1 class="text-xl md:text-2xl font-bold text-neutral-900 dark:text-white">Nova Categoria</h1>
        <p class="text-xs md:text-sm text-neutral-600 dark:text-neutral-400">Crie uma nova categoria e adicione produtos</p>
      </div>
    </div>
    
    <!-- Botão Voltar -->
    <div class="flex items-center gap-3">
      <a href="{% url 'get_all_categories' %}" 
         class="inline-flex items-center justify-center px-3 py-1.5 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-300 font-medium rounded text-xs bg-white dark:bg-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Voltar
      </a>
    </div>
  </div>

  <!-- Formulário Principal -->
  <form method="POST" enctype="multipart/form-data" class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 shadow-sm overflow-hidden flex-1 flex flex-col">
    {% csrf_token %}
    
    <!-- Container Principal com Layout Dividido -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
      
      <!-- Seção de Informações da Categoria -->
      <div class="lg:w-1/3 border-b lg:border-b-0 lg:border-r border-neutral-200 dark:border-neutral-700">
        <!-- Header da Seção -->
        <div class="px-4 md:px-6 py-3 border-b border-neutral-200 dark:border-neutral-700">
          <h2 class="text-base font-semibold text-neutral-900 dark:text-white">Informações da Categoria</h2>
          <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1">Defina os dados básicos da categoria</p>
        </div>
        
        <!-- Conteúdo da Seção -->
        <div class="p-4 md:p-6 space-y-4">
          <!-- Nome da Categoria -->
          <div>
            <label for="id_name" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
              Nome da Categoria *
            </label>
            {{ form.name }}
            {% if form.name.errors %}
              <p class="text-red-600 dark:text-red-400 text-sm mt-1 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ form.name.errors|first }}
              </p>
            {% endif %}
          </div>

          <!-- Descrição -->
          <div>
            <label for="id_description" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
              Descrição
            </label>
            {{ form.description }}
            {% if form.description.errors %}
              <p class="text-red-600 dark:text-red-400 text-sm mt-1 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ form.description.errors|first }}
              </p>
            {% endif %}
          </div>

          <!-- Upload de Imagem -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
              Imagem da Categoria
            </label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-neutral-300 dark:border-neutral-600 border-dashed rounded-lg hover:border-neutral-400 dark:hover:border-neutral-500 transition-colors duration-200">
              <div class="space-y-1 text-center">
                <svg class="mx-auto h-12 w-12 text-neutral-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                  <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="flex text-sm text-neutral-600 dark:text-neutral-400">
                  <label for="id_image_file" class="relative cursor-pointer bg-white dark:bg-neutral-800 rounded-md font-medium text-neutral-900 dark:text-white hover:text-neutral-700 dark:hover:text-neutral-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-neutral-500">
                    <span>Carregar imagem</span>
                    {{ form.image_file }}
                  </label>
                  <p class="pl-1">ou arraste aqui</p>
                </div>
                <p class="text-xs text-neutral-500 dark:text-neutral-400">PNG, JPG até 10MB</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção de Seleção de Produtos -->
      <div class="lg:w-2/3 flex flex-col">
        <!-- Header da Seção com Busca -->
        <div class="px-4 md:px-6 py-3 border-b border-neutral-200 dark:border-neutral-700">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold text-neutral-900 dark:text-white">Produtos da Categoria</h2>
              <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1">Selecione os produtos para esta categoria (opcional)</p>
            </div>
            
            <!-- Campo de Busca de Produtos -->
            <div class="relative w-full sm:w-64">
              <input 
                type="text" 
                id="productSearchInput"
                placeholder="Buscar produtos..."
                class="w-full px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-500 dark:focus:ring-neutral-400 transition-colors duration-200"
              >
              <svg class="absolute right-3 top-2.5 w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
          
          <!-- Contador de Selecionados -->
          <div class="mt-3 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <span id="selectedCount" class="text-xs text-neutral-600 dark:text-neutral-400">0 produtos selecionados</span>
              <button type="button" id="showSelectedBtn" class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors duration-200 hidden">
                Ver selecionados
              </button>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" id="selectAllBtn" class="text-xs text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors duration-200">
                Selecionar página
              </button>
              <span class="text-neutral-300 dark:text-neutral-600">|</span>
              <button type="button" id="deselectAllBtn" class="text-xs text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors duration-200">
                Desmarcar todos
              </button>
            </div>
          </div>
        </div>

        <!-- Lista de Produtos com Scroll -->
        <div class="flex-1 overflow-hidden">
          <div id="productsList" class="h-full overflow-y-auto custom-scrollbar">
            <div class="p-4 md:p-6">
              <!-- Grid de Produtos -->
              <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Os produtos serão renderizados aqui pelo JavaScript -->
              </div>
              
              <!-- Mensagem de Nenhum Produto -->
              <div id="noProductsMessage" class="hidden text-center py-8">
                <svg class="mx-auto h-12 w-12 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m13-8-4 4-4-4m-6 0L9 9l4-4"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-neutral-900 dark:text-white">Nenhum produto encontrado</h3>
                <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">Tente ajustar sua busca ou adicionar novos produtos</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Paginação de Produtos -->
        <div class="px-4 md:px-6 py-3 border-t border-neutral-200 dark:border-neutral-700">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
            <!-- Controle de Itens por Página -->
            <div class="flex items-center space-x-2">
              <span class="text-xs text-neutral-600 dark:text-neutral-400">Mostrar:</span>
              <select id="itemsPerPage" class="text-sm border border-neutral-300 dark:border-neutral-600 rounded px-2 py-1 bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 dark:focus:ring-neutral-400">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="25">25</option>
              </select>
              <span class="text-xs text-neutral-600 dark:text-neutral-400">por página</span>
            </div>

            <!-- Info de Resultados -->
            <div id="resultsInfo" class="text-xs text-neutral-600 dark:text-neutral-400">
              Carregando produtos...
            </div>

            <!-- Controles de Navegação -->
            <div class="flex items-center space-x-1">
              <button type="button" id="prevPage" class="inline-flex items-center px-3 py-1.5 border border-neutral-300 dark:border-neutral-600 text-sm font-medium rounded text-neutral-700 dark:text-neutral-300 bg-white dark:bg-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Anterior
              </button>
              
              <div id="pageNumbers" class="flex items-center space-x-1">
                <!-- Números de página serão inseridos aqui -->
              </div>
              
              <button type="button" id="nextPage" class="inline-flex items-center px-3 py-1.5 border border-neutral-300 dark:border-neutral-600 text-sm font-medium rounded text-neutral-700 dark:text-neutral-300 bg-white dark:bg-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Próxima
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer com Botões de Ação -->
    <div class="px-4 md:px-6 py-4 bg-neutral-50 dark:bg-neutral-900 border-t border-neutral-200 dark:border-neutral-700">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
        <div class="text-xs text-neutral-600 dark:text-neutral-400 order-2 sm:order-1">
          * Campos obrigatórios
        </div>
        
        <div class="flex items-center gap-3 order-1 sm:order-2">
          <a href="{% url 'get_all_categories' %}" 
             class="inline-flex items-center justify-center px-4 py-2 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-300 font-medium rounded-lg bg-white dark:bg-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors duration-200 text-sm">
            Cancelar
          </a>
          
          <button type="submit" 
                  class="inline-flex items-center justify-center px-4 py-2 bg-neutral-900 dark:bg-white text-white dark:text-neutral-900 font-medium rounded-lg hover:bg-neutral-800 dark:hover:bg-neutral-100 transition-all duration-200 shadow-sm hover:shadow-md text-sm">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Criar Categoria
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Produtos Data (Para JavaScript) -->
<script type="application/json" id="productsData">
  [
    {% for product in all_products %}
    {
      "id": {{ product.id }},
      "name": "{{ product.name|escapejs }}",
      "description": "{{ product.description|default:""|escapejs }}",
      "price": "{{ product.price }}",
      "stock_active": {{ product.stock_active|yesno:"true,false" }},
      "image_url": "{{ product.image_url|default:""|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
</script>

<style>
/* Scrollbar personalizada */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: #f5f5f5;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #d4d4d4;
  border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #a3a3a3;
}

.dark .custom-scrollbar::-webkit-scrollbar-track {
  background: #262626;
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb {
  background: #525252;
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #737373;
}

/* Layout móvel responsivo */
@media (max-width: 768px) {
  .mobile-content-padding {
    padding: 0.75rem;
  }
}

@media (min-width: 768px) {
  .mobile-content-padding {
    padding: 1.5rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Configuração da paginação e busca de produtos
  const ProductSelector = {
    products: [],
    filteredProducts: [],
    selectedProducts: new Set(),
    currentPage: 1,
    itemsPerPage: 10,
    isShowingSelectedOnly: false,
    originalSearchTerm: '',
    
    // Elementos do DOM
    elements: {
      searchInput: document.getElementById('productSearchInput'),
      productsGrid: document.getElementById('productsGrid'),
      selectedCount: document.getElementById('selectedCount'),
      selectAllBtn: document.getElementById('selectAllBtn'),
      deselectAllBtn: document.getElementById('deselectAllBtn'),
      showSelectedBtn: document.getElementById('showSelectedBtn'),
      noProductsMessage: document.getElementById('noProductsMessage'),
      resultsInfo: document.getElementById('resultsInfo'),
      itemsPerPage: document.getElementById('itemsPerPage'),
      prevPage: document.getElementById('prevPage'),
      nextPage: document.getElementById('nextPage'),
      pageNumbers: document.getElementById('pageNumbers')
    },
    
    init() {
      // Carregar dados dos produtos
      const productsScript = document.getElementById('productsData');
      if (productsScript) {
        try {
          this.products = JSON.parse(productsScript.textContent);
          this.filteredProducts = [...this.products];
        } catch (e) {
          console.error('Erro ao carregar produtos:', e);
          this.products = [];
          this.filteredProducts = [];
        }
      }
      
      // Configurar event listeners
      this.setupEventListeners();
      
      // Renderizar inicial
      this.render();
    },
    
    setupEventListeners() {
      // Busca
      if (this.elements.searchInput) {
        this.elements.searchInput.addEventListener('input', (e) => {
          // Não permitir busca quando mostrando apenas selecionados
          if (this.isShowingSelectedOnly) return;
          
          this.filterProducts(e.target.value.toLowerCase());
          this.currentPage = 1;
          this.render();
        });
      }
      
      // Controles de seleção
      if (this.elements.selectAllBtn) {
        this.elements.selectAllBtn.addEventListener('click', () => {
          this.selectAllVisible();
        });
      }
      
      if (this.elements.deselectAllBtn) {
        this.elements.deselectAllBtn.addEventListener('click', () => {
          this.deselectAll();
        });
      }
      
      // Botão ver selecionados
      if (this.elements.showSelectedBtn) {
        this.elements.showSelectedBtn.addEventListener('click', () => {
          if (this.isShowingSelectedOnly) {
            this.showAllProducts();
          } else {
            this.showSelectedProducts();
          }
        });
      }
      
      // Paginação
      if (this.elements.itemsPerPage) {
        this.elements.itemsPerPage.addEventListener('change', (e) => {
          this.itemsPerPage = parseInt(e.target.value);
          this.currentPage = 1;
          this.render();
        });
      }
      
      if (this.elements.prevPage) {
        this.elements.prevPage.addEventListener('click', () => {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.render();
          }
        });
      }
      
      if (this.elements.nextPage) {
        this.elements.nextPage.addEventListener('click', () => {
          const totalPages = Math.ceil(this.filteredProducts.length / this.itemsPerPage);
          if (this.currentPage < totalPages) {
            this.currentPage++;
            this.render();
          }
        });
      }
    },
    
    filterProducts(searchTerm) {
      if (searchTerm === '') {
        this.filteredProducts = [...this.products];
      } else {
        this.filteredProducts = this.products.filter(product => {
          return product.name.toLowerCase().includes(searchTerm) ||
                 (product.description && product.description.toLowerCase().includes(searchTerm));
        });
      }
    },
    
    selectAllVisible() {
      const startIndex = (this.currentPage - 1) * this.itemsPerPage;
      const endIndex = startIndex + this.itemsPerPage;
      const visibleProducts = this.filteredProducts.slice(startIndex, endIndex);
      
      visibleProducts.forEach(product => {
        this.selectedProducts.add(product.id);
      });
      
      this.updateSelectedCount();
      this.updateHiddenInputs();
      this.render(); // Re-render para atualizar o visual
    },
    
    deselectAll() {
      this.selectedProducts.clear();
      this.updateSelectedCount();
      this.updateHiddenInputs();
      this.render(); // Re-render para atualizar o visual
    },
    
    toggleProduct(productId) {
      if (this.selectedProducts.has(productId)) {
        this.selectedProducts.delete(productId);
      } else {
        this.selectedProducts.add(productId);
      }
      
      this.updateSelectedCount();
      this.updateHiddenInputs();
      this.render(); // Re-render para atualizar o visual
    },
    
    updateSelectedCount() {
      if (this.elements.selectedCount) {
        const count = this.selectedProducts.size;
        this.elements.selectedCount.textContent = `${count} produto${count !== 1 ? 's' : ''} selecionado${count !== 1 ? 's' : ''} (global)`;
      }
      
      // Mostrar/ocultar botão "Ver selecionados"
      if (this.elements.showSelectedBtn) {
        if (this.selectedProducts.size > 0) {
          this.elements.showSelectedBtn.classList.remove('hidden');
        } else {
          this.elements.showSelectedBtn.classList.add('hidden');
        }
      }
    },
    
    showSelectedProducts() {
      if (this.selectedProducts.size === 0) return;
      
      // Salvar termo de busca atual
      this.originalSearchTerm = this.elements.searchInput ? this.elements.searchInput.value : '';
      
      // Marcar que estamos mostrando apenas selecionados
      this.isShowingSelectedOnly = true;
      
      // Filtrar para mostrar apenas produtos selecionados
      this.filteredProducts = this.products.filter(product => 
        this.selectedProducts.has(product.id)
      );
      
      this.currentPage = 1;
      
      // Atualizar interface
      this.render();
      
      // Alterar botão para "Mostrar todos"
      if (this.elements.showSelectedBtn) {
        this.elements.showSelectedBtn.textContent = 'Mostrar todos';
      }
      
      // Limpar campo de busca temporariamente
      if (this.elements.searchInput) {
        this.elements.searchInput.value = '';
        this.elements.searchInput.disabled = true;
        this.elements.searchInput.placeholder = 'Mostrando apenas selecionados...';
      }
    },
    
    showAllProducts() {
      // Marcar que não estamos mais mostrando apenas selecionados
      this.isShowingSelectedOnly = false;
      
      // Restaurar campo de busca
      if (this.elements.searchInput) {
        this.elements.searchInput.disabled = false;
        this.elements.searchInput.placeholder = 'Buscar produtos...';
        this.elements.searchInput.value = this.originalSearchTerm;
      }
      
      // Reaplica o filtro com o termo de busca original
      this.filterProducts(this.originalSearchTerm.toLowerCase());
      this.currentPage = 1;
      
      // Atualizar interface
      this.render();
      
      // Alterar botão para "Ver selecionados"
      if (this.elements.showSelectedBtn) {
        this.elements.showSelectedBtn.textContent = 'Ver selecionados';
      }
    },
    
    
    updateHiddenInputs() {
      // Remove todos os inputs ocultos existentes
      const existingInputs = document.querySelectorAll('input[name="products"][type="hidden"]');
      existingInputs.forEach(input => input.remove());
      
      // Adiciona um input oculto para cada produto selecionado
      const form = document.querySelector('form');
      this.selectedProducts.forEach(productId => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'products';
        hiddenInput.value = productId;
        form.appendChild(hiddenInput);
      });
    },
    
    render() {
      this.renderProducts();
      this.renderPagination();
      this.updateResultsInfo();
      this.updateSelectedCount();
      this.updateHiddenInputs();
    },
    
    renderProducts() {
      if (!this.elements.productsGrid) return;
      
      const totalPages = Math.ceil(this.filteredProducts.length / this.itemsPerPage);
      const startIndex = (this.currentPage - 1) * this.itemsPerPage;
      const endIndex = startIndex + this.itemsPerPage;
      const currentProducts = this.filteredProducts.slice(startIndex, endIndex);
      
      if (currentProducts.length === 0) {
        this.elements.productsGrid.innerHTML = '';
        this.elements.noProductsMessage.classList.remove('hidden');
        return;
      }
      
      this.elements.noProductsMessage.classList.add('hidden');
      
      this.elements.productsGrid.innerHTML = currentProducts.map(product => {
        const isSelected = this.selectedProducts.has(product.id);
        return `
        <div class="bg-neutral-50 dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-700 p-3 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors duration-200 cursor-pointer ${isSelected ? 'ring-2 ring-neutral-500 dark:ring-neutral-400 bg-neutral-100 dark:bg-neutral-800' : ''}" 
             onclick="ProductSelector.toggleProduct(${product.id})">
          <div class="flex items-start gap-3">
            <!-- Checkbox -->
            <div class="flex-shrink-0 mt-1">
              <input type="checkbox" 
                     value="${product.id}" 
                     id="product_${product.id}"
                     ${isSelected ? 'checked' : ''}
                     class="w-4 h-4 text-neutral-900 bg-neutral-100 border-neutral-300 rounded focus:ring-neutral-500 dark:focus:ring-neutral-400 dark:ring-offset-neutral-800 focus:ring-2 dark:bg-neutral-700 dark:border-neutral-600 pointer-events-none"
                     readonly>
            </div>
            
            <!-- Conteúdo do Produto -->
            <div class="flex-1 min-w-0">
              <div class="block">
                <div class="flex items-center justify-between mb-1">
                  <h3 class="text-sm font-medium text-neutral-900 dark:text-white truncate">${product.name}</h3>
                  <span class="flex-shrink-0 ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${product.stock_active ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100' : 'bg-neutral-100 text-neutral-800 dark:bg-neutral-700 dark:text-neutral-300'}">
                    ${product.stock_active ? 'Ativo' : 'Inativo'}
                  </span>
                </div>
                
                <p class="text-xs text-neutral-600 dark:text-neutral-400 line-clamp-2 mb-2">
                  ${product.description || 'Sem descrição'}
                </p>
                
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold text-neutral-900 dark:text-white">
                    R$ ${parseFloat(product.price).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </span>
                  <span class="text-xs text-neutral-500 dark:text-neutral-400">
                    ID: ${product.id}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      }).join('');
      
      // Atualizar controles de navegação
      if (this.elements.prevPage) {
        this.elements.prevPage.disabled = this.currentPage === 1;
      }
      
      if (this.elements.nextPage) {
        this.elements.nextPage.disabled = this.currentPage === totalPages || totalPages === 0;
      }
    },
    
    renderPagination() {
      if (!this.elements.pageNumbers) return;
      
      const totalPages = Math.ceil(this.filteredProducts.length / this.itemsPerPage);
      this.elements.pageNumbers.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Mostrar máximo 5 números de página
      let startPage = Math.max(1, this.currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.type = 'button';
        pageButton.textContent = i;
        pageButton.className = `px-3 py-1.5 text-sm font-medium rounded transition-colors duration-200 ${
          i === this.currentPage 
            ? 'bg-neutral-900 dark:bg-white text-white dark:text-neutral-900' 
            : 'border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-300 bg-white dark:bg-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-700'
        }`;
        
        pageButton.addEventListener('click', () => {
          this.currentPage = i;
          this.render();
        });
        
        this.elements.pageNumbers.appendChild(pageButton);
      }
    },
    
    updateResultsInfo() {
      if (!this.elements.resultsInfo) return;
      
      const totalItems = this.filteredProducts.length;
      const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
      const endIndex = Math.min(this.currentPage * this.itemsPerPage, totalItems);
      
      if (totalItems === 0) {
        if (this.isShowingSelectedOnly) {
          this.elements.resultsInfo.textContent = 'Nenhum produto selecionado';
        } else {
          this.elements.resultsInfo.textContent = 'Nenhum produto encontrado';
        }
      } else {
        const suffix = this.isShowingSelectedOnly ? ' selecionados' : ' produtos';
        this.elements.resultsInfo.textContent = `Mostrando ${startIndex}-${endIndex} de ${totalItems}${suffix}`;
      }
    }
  };
  
  // Inicializar o seletor de produtos
  ProductSelector.init();
  
  // Tornar disponível globalmente
  window.ProductSelector = ProductSelector;
});
</script>
{% endblock %}
